Goals:
 - Write up of the current status of Diagnsotics in AOT
 - Proposal for way forward including 8.0 recommendations

 Resources
  - https://docs.microsoft.com/en-us/dotnet/core/diagnostics/


Local resources:
 - laptop
  - C:\work\core\LakshanF\CSharp\src\aot\experiments\Diagnostics\Logging


A) - Logging
..\..\..\..\..\run.bat

C:\work\core\Tools\PerfView.exe

DiagnsoticSource, EventSource

Demo:1:4

1) .NET
 
dotnet publish -r win-x64 --self-contained true

C:\Work\Core\LakshanF\CSharp\src\aot\experiments\Diagnostics\Logging\EventSource\DotNet\bin\Debug\net7.0\win-x64\publish\DotNetTest.exe
71 MB (with App size around 152 KB)

a) PerfView
Can See events (see below for nettrace stats)

b) dotnet-trace
pushd C:\Work\Core\LakshanF\CSharp\src\aot\experiments\Diagnostics\Logging\EventSource\DotNet\bin\Debug\net7.0\win-x64\publish

dotnet-trace collect --providers Demo -- DotNetTest.exe

Ex. DotNetTest.exe_20221106_060019.nettrace (152 KB)

C:\work\core\Test\8_18\sdk\Diagnostics\EventSource\DotNet\bin\Debug\net7.0\win-x64\publish\DotNetTest.exe_20220829_162804.nettrace

Can see events

Name	Count	AverageSize	StackCount
Microsoft-Windows-DotNETRuntimeRundown/Method/DCStopVerbose	620	262	0
Microsoft-Windows-DotNETRuntimeRundown/Method/ILToNativeMapDCStop	20	271	0
Microsoft-Windows-DotNETRuntimeRundown/Loader/ModuleDCStop	4	576	0
Microsoft-Windows-DotNETRuntimeRundown/Loader/DomainModuleDCStop	4	324	0
Microsoft-Windows-DotNETRuntimeRundown/Loader/AssemblyDCStop	4	196	0
Demo/DebugMessage	2	49	2
Demo/AppStarted	1	50	1
Demo/Request/Start	1	4	1
Demo/Request/Stop	1	4	1
Microsoft-DotNETCore-EventPipe/ProcessInfo	1	58	0
Microsoft-Windows-DotNETRuntimeRundown/Runtime/Start	1	309	0
Microsoft-Windows-DotNETRuntimeRundown/Method/DCStopInit	1	2	0
Microsoft-Windows-DotNETRuntimeRundown/Loader/AppDomainDCStop	1	34	0
Microsoft-Windows-DotNETRuntimeRundown/Method/DCStopComplete	1	2	0

2) NativeAOT
dotnet publish -r win-x64 -c Debug /p:PublishAot=true

C:\Work\Core\LakshanF\CSharp\src\aot\experiments\Diagnostics\Logging\EventSource\NativeAOT\bin\Debug\net7.0\win-x64\publish\NativeAotTest.exe
6 MB

C:\work\core\Test\8_18\sdk\Diagnostics\EventSource\PerfView\NativeAOT

a) PerfView (Can NOT see relevant events even though some related events can be seen)
 - C:\work\core\Tools\PerfView.exe
 - launch the app via the collect option
 - add the following to the "Addtional Providers", "Demo:1:4"
  

 - Related Events
Microsoft-Windows-DotNETRuntime/Exception/Start
Microsoft-Windows-DotNETRuntime/GC/AllocationTick
Microsoft-Windows-DotNETRuntime/GC/CreateSegment



b) dotnet-trace
https://docs.microsoft.com/en-us/dotnet/core/diagnostics/dotnet-trace
  Enables the collection of .NET Core traces of a running process without a native profiler.

pushd C:\Work\Core\LakshanF\CSharp\src\aot\experiments\Diagnostics\Logging\EventSource\NativeAOT\bin\Debug\net7.0\win-x64\publish

dotnet-trace collect --providers Demo -- NativeAotTest.exe

collect --providers Demo -- C:\work\core\LakshanF\CSharp\src\aot\experiments\Diagnostics\Logging\EventSource\NativeAOT\bin\Debug\net7.0\win-x64\publish\NativeAotTest.exe

PROBABLE CAUSE:
 - EventPipe is not NativeAOT friendly and dotnet tracing tools (dotnet-trace, counters, gcdump) to not work
    + EventPipe port to runtime (C++) was started but needs to happen
    + https://docs.microsoft.com/en-us/dotnet/core/diagnostics/eventpipe
      * However, because EventPipe is a runtime built-in component, its scope is limited to managed code and the runtime itself.
    + It seems to expect the application that is being monitored for trace/logging to be managed (See callstack below)
      * ReversedDiagnosticsServer.Accept time outs
        - private readonly HandleableCollection<IpcEndpointInfo> _endpointInfos = new HandleableCollection<IpcEndpointInfo>();
        - IpcEndpointInfo: Represents a runtine instance connection to a reversed diagnostics server.
  - Read Diagnostics port
    + https://docs.microsoft.com/en-us/dotnet/core/diagnostics/diagnostic-port
      * The .NET Core runtime exposes a service endpoint that allows other processes to send diagnostic commands and receive responses over an IPC channe

POSSIBLE SOLUTION:
  - Make EventPipe handle nativeaot apps as well
    + How? https://docs.microsoft.com/en-us/dotnet/core/diagnostics/diagnostics-client-library

C:\Work\Core\LakshanF\CSharp\src\aot\experiments\Diagnostics\Logging\EventSource\NativeAOT\bin\Debug\net7.0\win-x64\publish>dotnet-trace collect --providers Demo -- NativeAotTest.exe

Provider Name                           Keywords            Level               Enabled By
Demo                                    0xFFFFFFFFFFFFFFFF  Verbose(5)          --providers

Launching: NativeAotTest.exe 
Unable to start tracing session - the target app failed to connect to the diagnostics port. This may happen if the target application is running .NET Core 3.1 or older versions. Attaching at startup is only available from .NET 5.0 or later.
[ERROR] System.TimeoutException: The operation has timed out.
   at Microsoft.Diagnostics.NETCore.Client.HandleableCollection`1.Handle(Handler handler, TimeSpan timeout) in /_/src/Microsoft.Diagnostics.NETCore.Client/HandleableCollection.cs:line 156
   at Microsoft.Diagnostics.NETCore.Client.HandleableCollection`1.Handle(TimeSpan timeout) in /_/src/Microsoft.Diagnostics.NETCore.Client/HandleableCollection.cs:line 131
   at Microsoft.Diagnostics.NETCore.Client.ReversedDiagnosticsServer.Accept(TimeSpan timeout) in /_/src/Microsoft.Diagnostics.NETCore.Client/ReversedServer/ReversedDiagnosticsServer.cs:line 141
   at Microsoft.Internal.Common.Utils.DiagnosticsClientBuilder.Build(CancellationToken ct, Int32 processId, String diagnosticPort, Boolean showChildIO, Boolean printLaunchCommand) in /_/src/Tools/Common/ReversedServerHelpers/ReversedServerHelpers.cs:line 225
   at Microsoft.Diagnostics.Tools.Trace.CollectCommandHandler.Collect(CancellationToken ct, IConsole console, Int32 processId, FileInfo output, UInt32 buffersize, String providers, String profile, TraceFileFormat format, TimeSpan duration, String clrevents, String clreventlevel, String name, String diagnosticPort, Boolean showchildio, Boolean resumeRuntime) in /_/src/Tools/dotnet-trace/CommandLine/Commands/CollectCommand.cs:line 157

B) Debugging
Debug 
 - VS: debenv -debugexe <pathToNativeAotExe>
 - Open the source
 - setup a bp and start debugging (F5)

Observations
 - Stack (mangled names but reasonable)
 - Disassebmly has debug symbols
 - F10, F11, Local Views, virtual methods (FEEFEEFOO)
 - Not working: Interface calls
 - Partially working: yield return, state machine

ASK:
- Dump Debugging: to be comtaible with coreclr
	* During development, build time debugging experience will be coreclr (nativeaot comes at publish) and that can be sufficient


C) Dotnet-trace (AOT it)
https://github.com/dotnet/diagnostics
c:\work\core\main\diagnostics

C:\work\core\main\diagnostics\artifacts\bin\dotnet-trace\Release\net7.0\win-x64\publish\dotnet-trace.exe

-----------------

dotnet add package Microsoft.Diagnostics.NETCore.Client --version 0.2.351802

dotnet add package Microsoft.Diagnostics.Tracing.TraceEvent --version 3.0.5

dotnet remove package Microsoft.Diagnostics.Tracing.TraceEvent --version 3.0.5

C:\Work\Core\main\runtime\src\coreclr\tools\aot\ilc.sln
C:\Work\Core\CurrentWork3\runtime\src\coreclr\tools\aot\ilc.sln

C:\Work\Core\main\runtime\src\coreclr\tools\aot\ILCompiler\reproNative\reproNative.vcxproj
C:\Work\Core\CurrentWork3\runtime\src\coreclr\tools\aot\ILCompiler\reproNative\reproNative.vcxproj




- Does not work in either main or CurrentWork3
build.cmd clr.aot+libs -rc Release
C:\Work\Core\main\runtime\artifacts\bin\repro\x64\Release\compile-with-Release-libs.rsp
C:\Work\Core\CurrentWork3\runtime\artifacts\bin\repro\x64\Release\compile-with-Release-libs.rsp

 - works in main
 - work in CurrentWork3 without DS initialization
build.cmd clr.aot+libs -rc Debug
C:\Work\Core\main\runtime\artifacts\bin\repro\x64\Debug\compile-with-Debug-libs.rsp
C:\Work\Core\CurrentWork3\runtime\artifacts\bin\repro\x64\Debug\compile-with-Debug-libs.rsp



1>   Creating library C:\Work\Core\CurrentWork3\runtime\src\coreclr\tools\aot\ILCompiler\reproNative\x64\Debug\reproNative.lib and object C:\Work\Core\CurrentWork3\runtime\src\coreclr\tools\aot\ILCompiler\reproNative\x64\Debug\reproNative.exp
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "bool __cdecl ds_ipc_pal_init(void)" (?ds_ipc_pal_init@@YA_NXZ) referenced in function "bool __cdecl ds_server_init(void)" (?ds_server_init@@YA_NXZ)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "bool __cdecl ds_ipc_pal_shutdown(void)" (?ds_ipc_pal_shutdown@@YA_NXZ) referenced in function "bool __cdecl ds_server_shutdown(void)" (?ds_server_shutdown@@YA_NXZ)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "struct _DiagnosticsIpc * __cdecl ds_ipc_alloc(char const *,enum DiagnosticsIpcConnectionMode,void (__cdecl*)(char const *,unsigned int))" (?ds_ipc_alloc@@YAPEAU_DiagnosticsIpc@@PEBDW4DiagnosticsIpcConnectionMode@@P6AX0I@Z@Z) referenced in function "bool __cdecl ipc_stream_factory_build_and_add_port(struct _DiagnosticsPortBuilder *,void (__cdecl*)(char const *,unsigned int),bool)" (?ipc_stream_factory_build_and_add_port@@YA_NPEAU_DiagnosticsPortBuilder@@P6AXPEBDI@Z_N@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "void __cdecl ds_ipc_free(struct _DiagnosticsIpc *)" (?ds_ipc_free@@YAXPEAU_DiagnosticsIpc@@@Z) referenced in function "bool __cdecl ipc_stream_factory_build_and_add_port(struct _DiagnosticsPortBuilder *,void (__cdecl*)(char const *,unsigned int),bool)" (?ipc_stream_factory_build_and_add_port@@YA_NPEAU_DiagnosticsPortBuilder@@P6AXPEBDI@Z_N@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "int __cdecl ds_ipc_poll(struct _DiagnosticsIpcPollHandle *,unsigned __int64,unsigned int,void (__cdecl*)(char const *,unsigned int))" (?ds_ipc_poll@@YAHPEAU_DiagnosticsIpcPollHandle@@_KIP6AXPEBDI@Z@Z) referenced in function "struct _DiagnosticsIpcStream * __cdecl ds_ipc_stream_factory_get_next_available_stream(void (__cdecl*)(char const *,unsigned int))" (?ds_ipc_stream_factory_get_next_available_stream@@YAPEAU_DiagnosticsIpcStream@@P6AXPEBDI@Z@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "bool __cdecl ds_ipc_listen(struct _DiagnosticsIpc *,void (__cdecl*)(char const *,unsigned int))" (?ds_ipc_listen@@YA_NPEAU_DiagnosticsIpc@@P6AXPEBDI@Z@Z) referenced in function "bool __cdecl ipc_stream_factory_build_and_add_port(struct _DiagnosticsPortBuilder *,void (__cdecl*)(char const *,unsigned int),bool)" (?ipc_stream_factory_build_and_add_port@@YA_NPEAU_DiagnosticsPortBuilder@@P6AXPEBDI@Z_N@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "struct _DiagnosticsIpcStream * __cdecl ds_ipc_accept(struct _DiagnosticsIpc *,void (__cdecl*)(char const *,unsigned int))" (?ds_ipc_accept@@YAPEAU_DiagnosticsIpcStream@@PEAU_DiagnosticsIpc@@P6AXPEBDI@Z@Z) referenced in function "struct _DiagnosticsIpcStream * __cdecl listen_port_get_connected_stream_func(void *,void (__cdecl*)(char const *,unsigned int))" (?listen_port_get_connected_stream_func@@YAPEAU_DiagnosticsIpcStream@@PEAXP6AXPEBDI@Z@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "struct _DiagnosticsIpcStream * __cdecl ds_ipc_connect(struct _DiagnosticsIpc *,unsigned int,void (__cdecl*)(char const *,unsigned int),bool *)" (?ds_ipc_connect@@YAPEAU_DiagnosticsIpcStream@@PEAU_DiagnosticsIpc@@IP6AXPEBDI@ZPEA_N@Z) referenced in function "bool __cdecl connect_port_get_ipc_poll_handle_func(void *,struct _DiagnosticsIpcPollHandle *,void (__cdecl*)(char const *,unsigned int))" (?connect_port_get_ipc_poll_handle_func@@YA_NPEAXPEAU_DiagnosticsIpcPollHandle@@P6AXPEBDI@Z@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "void __cdecl ds_ipc_close(struct _DiagnosticsIpc *,bool,void (__cdecl*)(char const *,unsigned int))" (?ds_ipc_close@@YAXPEAU_DiagnosticsIpc@@_NP6AXPEBDI@Z@Z) referenced in function "void __cdecl ds_port_close(struct _DiagnosticsPort *,bool,void (__cdecl*)(char const *,unsigned int))" (?ds_port_close@@YAXPEAU_DiagnosticsPort@@_NP6AXPEBDI@Z@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "int __cdecl ds_ipc_to_string(struct _DiagnosticsIpc *,char *,unsigned int)" (?ds_ipc_to_string@@YAHPEAU_DiagnosticsIpc@@PEADI@Z) referenced in function "void __cdecl ipc_log_poll_handles(struct _rt_aot_array_internal_t<struct _DiagnosticsIpcPollHandle> *)" (?ipc_log_poll_handles@@YAXPEAU?$_rt_aot_array_internal_t@U_DiagnosticsIpcPollHandle@@@@@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "int __cdecl ds_ipc_stream_get_handle_int32_t(struct _DiagnosticsIpcStream *)" (?ds_ipc_stream_get_handle_int32_t@@YAHPEAU_DiagnosticsIpcStream@@@Z) referenced in function "struct _DiagnosticsIpcStream * __cdecl ds_ipc_stream_factory_get_next_available_stream(void (__cdecl*)(char const *,unsigned int))" (?ds_ipc_stream_factory_get_next_available_stream@@YAPEAU_DiagnosticsIpcStream@@P6AXPEBDI@Z@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "struct _IpcStream * __cdecl ds_ipc_stream_get_stream_ref(struct _DiagnosticsIpcStream *)" (?ds_ipc_stream_get_stream_ref@@YAPEAU_IpcStream@@PEAU_DiagnosticsIpcStream@@@Z) referenced in function "bool __cdecl eventpipe_protocol_helper_collect_tracing(struct _DiagnosticsIpcMessage *,struct _DiagnosticsIpcStream *)" (?eventpipe_protocol_helper_collect_tracing@@YA_NPEAU_DiagnosticsIpcMessage@@PEAU_DiagnosticsIpcStream@@@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "void __cdecl ds_ipc_stream_free(struct _DiagnosticsIpcStream *)" (?ds_ipc_stream_free@@YAXPEAU_DiagnosticsIpcStream@@@Z) referenced in function "bool __cdecl connect_port_get_ipc_poll_handle_func(void *,struct _DiagnosticsIpcPollHandle *,void (__cdecl*)(char const *,unsigned int))" (?connect_port_get_ipc_poll_handle_func@@YA_NPEAXPEAU_DiagnosticsIpcPollHandle@@P6AXPEBDI@Z@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "bool __cdecl ds_ipc_stream_read(struct _DiagnosticsIpcStream *,unsigned char *,unsigned int,unsigned int *,unsigned int)" (?ds_ipc_stream_read@@YA_NPEAU_DiagnosticsIpcStream@@PEAEIPEAII@Z) referenced in function "bool __cdecl ipc_message_try_parse(struct _DiagnosticsIpcMessage *,struct _DiagnosticsIpcStream *)" (?ipc_message_try_parse@@YA_NPEAU_DiagnosticsIpcMessage@@PEAU_DiagnosticsIpcStream@@@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "bool __cdecl ds_ipc_stream_write(struct _DiagnosticsIpcStream *,unsigned char const *,unsigned int,unsigned int *,unsigned int)" (?ds_ipc_stream_write@@YA_NPEAU_DiagnosticsIpcStream@@PEBEIPEAII@Z) referenced in function "bool __cdecl ds_icp_advertise_v1_send(struct _DiagnosticsIpcStream *)" (?ds_icp_advertise_v1_send@@YA_NPEAU_DiagnosticsIpcStream@@@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "bool __cdecl ds_ipc_stream_flush(struct _DiagnosticsIpcStream *)" (?ds_ipc_stream_flush@@YA_NPEAU_DiagnosticsIpcStream@@@Z) referenced in function "bool __cdecl eventpipe_protocol_helper_stop_tracing(struct _DiagnosticsIpcMessage *,struct _DiagnosticsIpcStream *)" (?eventpipe_protocol_helper_stop_tracing@@YA_NPEAU_DiagnosticsIpcMessage@@PEAU_DiagnosticsIpcStream@@@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "bool __cdecl ds_ipc_stream_close(struct _DiagnosticsIpcStream *,void (__cdecl*)(char const *,unsigned int))" (?ds_ipc_stream_close@@YA_NPEAU_DiagnosticsIpcStream@@P6AXPEBDI@Z@Z) referenced in function "void __cdecl ds_port_close(struct _DiagnosticsPort *,bool,void (__cdecl*)(char const *,unsigned int))" (?ds_port_close@@YAXPEAU_DiagnosticsPort@@_NP6AXPEBDI@Z@Z)
1>Runtime.WorkstationGC.lib(ds-sources.c.obj) : error LNK2019: unresolved external symbol "int __cdecl ds_ipc_stream_to_string(struct _DiagnosticsIpcStream *,char *,unsigned int)" (?ds_ipc_stream_to_string@@YAHPEAU_DiagnosticsIpcStream@@PEADI@Z) referenced in function "bool __cdecl connect_port_get_ipc_poll_handle_func(void *,struct _DiagnosticsIpcPollHandle *,void (__cdecl*)(char const *,unsigned int))" (?connect_port_get_ipc_poll_handle_func@@YA_NPEAXPEAU_DiagnosticsIpcPollHandle@@P6AXPEBDI@Z@Z)
1>Runtime.WorkstationGC.lib(ep-sources.c.obj) : error LNK2019: unresolved external symbol "__declspec(dllimport) int __cdecl FreeLibrary(void *)" (__imp_?FreeLibrary@@YAHPEAX@Z) referenced in function "void __cdecl sample_profiler_unload_dependencies(void)" (?sample_profiler_unload_dependencies@@YAXXZ)
1>Runtime.WorkstationGC.lib(ep-sources.c.obj) : error LNK2019: unresolved external symbol "struct HWND__ * __cdecl LoadLibraryW(wchar_t const *)" (?LoadLibraryW@@YAPEAUHWND__@@PEB_W@Z) referenced in function "bool __cdecl sample_profiler_load_dependencies(void)" (?sample_profiler_load_dependencies@@YA_NXZ)
1>Runtime.WorkstationGC.lib(ep-sources.c.obj) : error LNK2019: unresolved external symbol "bool __cdecl ep_rt_aot_walk_managed_stack_for_thread(class Thread *,struct _EventPipeStackContents *)" (?ep_rt_aot_walk_managed_stack_for_thread@@YA_NPEAVThread@@PEAU_EventPipeStackContents@@@Z) referenced in function "bool __cdecl ep_rt_walk_managed_stack_for_thread(class Thread *,struct _EventPipeStackContents *)" (?ep_rt_walk_managed_stack_for_thread@@YA_NPEAVThread@@PEAU_EventPipeStackContents@@@Z)
1>Runtime.WorkstationGC.lib(ep-sources.c.obj) : error LNK2019: unresolved external symbol "void __cdecl ep_rt_aot_sample_profiler_write_sampling_event_for_threads(class Thread *,struct _EventPipeEvent *)" (?ep_rt_aot_sample_profiler_write_sampling_event_for_threads@@YAXPEAVThread@@PEAU_EventPipeEvent@@@Z) referenced in function "void __cdecl ep_rt_sample_profiler_write_sampling_event_for_threads(class Thread *,struct _EventPipeEvent *)" (?ep_rt_sample_profiler_write_sampling_event_for_threads@@YAXPEAVThread@@PEAU_EventPipeEvent@@@Z)
1>Runtime.WorkstationGC.lib(ep-sources.c.obj) : error LNK2001: unresolved external symbol "struct _rt_aot_lock_internal_t _ep_rt_aot_config_lock_handle" (?_ep_rt_aot_config_lock_handle@@3U_rt_aot_lock_internal_t@@A)
1>Runtime.WorkstationGC.lib(ep-sources.c.obj) : error LNK2001: unresolved external symbol "private: static class EventPipeCoreCLRThreadHolderTLS EventPipeCoreCLRThreadHolderTLS::g_threadHolderTLS" (?g_threadHolderTLS@EventPipeCoreCLRThreadHolderTLS@@0V1@A)